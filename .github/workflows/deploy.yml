name: Build and Deploy to Infomaniak

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Restaurer le package.json pour le build
      run: |
        echo "# Copie du package-build.json vers package.json pour le build"
        if [ -f package-build.json ] && [ -s package-build.json ]; then
          cp package-build.json package.json
          echo "✅ Package.json configuré pour le build"
        else
          echo "❌ Pas de package-build.json disponible"
          exit 1
        fi

    - name: Install dependencies and build
      run: |
        echo "=== Installation des dépendances ==="
        npm ci
        echo "=== Build Next.js ==="
        npm run build
        echo "✅ Build terminé"

    - name: Préparation des fichiers de production
      run: |
        echo "=== Préparation des fichiers de production ==="
        
        # Restaurer le package.json simple pour la production
        cat > package.json << 'EOF'
        {
          "name": "copenhague-trip-static",
          "version": "1.0.0",
          "private": true,
          "engines": {
            "node": ">=18"
          },
          "scripts": {
            "start": "node server.js"
          },
          "dependencies": {
            "express": "^4.18.2"
          }
        }
        EOF
        
        # Supprimer les anciens lock files
        rm -f package-lock.json
        
        # Vérification des fichiers
        if [ -d "out" ]; then
          echo "✅ Dossier out/ trouvé avec les fichiers statiques"
          ls -la out/
        else
          echo "❌ Pas de dossier out/ - le build a échoué"
          exit 1
        fi
        
        echo "=== Fichiers qui seront déployés ==="
        ls -la
        
        echo "=== Vérification des fichiers critiques ==="
        if [ -f "out/index.html" ]; then
          echo "✅ index.html présent"
        else
          echo "❌ index.html manquant"
        fi
        
        if [ -f "server.js" ]; then
          echo "✅ server.js présent"
        else
          echo "❌ server.js manquant"
        fi
        
        if [ -f "package.json" ]; then
          echo "✅ package.json présent"
        else
          echo "❌ package.json manquant"
        fi

    - name: Deploy to Infomaniak
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./out/
        server-dir: /srv/customer/sites/voyage.mathisinternicola.fr/
        exclude: |
          .git*
          .git*/**
          node_modules/**
          src/**
          *.md
          .eslintrc.json
          eslint.config.mjs
          next.config.js
          postcss.config.mjs
          tailwind.config.ts
          tsconfig.json
          .nvmrc
          .npmrc
          package-build.json
                dangerous-clean-slate: true 
