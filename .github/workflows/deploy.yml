name: Build and Deploy Static Site to Infomaniak

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js static site
        run: npm run build
        
      - name: Verify build output
        run: |
          echo "=== Contenu du dossier out ==="
          ls -la out/
          echo "=== V√©rification index.html ==="
          test -f out/index.html && echo "‚úÖ index.html existe" || echo "‚ùå index.html manquant"
          echo "=== V√©rification CSS ==="
          find out/_next -name "*.css" | head -3
          echo "=== Taille totale ==="
          du -sh out/

      - name: Install SFTP client
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy static files via SFTP
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_SERVER_DIR: ${{ secrets.FTP_SERVER_DIR }}
        run: |
          # Cr√©er un script SFTP pour d√©ployer seulement les fichiers statiques
          cat << EOF > deploy_script.lftp
          set ssl:verify-certificate no
          set ftp:ssl-allow no
          open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_SERVER
          
          # Nettoyer le dossier de destination (sauf certains fichiers)
          cd $FTP_SERVER_DIR
          rm -rf _next 2>/dev/null || true
          rm -f *.html 2>/dev/null || true
          rm -f *.jpg *.png *.svg 2>/dev/null || true
          rm -rf accommodation discoveries flights map news packing-list payments tips todo weather 404 2>/dev/null || true
          
          # Uploader SEULEMENT le contenu du dossier out
          lcd out
          mirror --reverse --delete --verbose ./
          
          # V√©rifier le d√©ploiement
          ls -la
          quit
          EOF
          
          # Ex√©cuter le script SFTP
          lftp -f deploy_script.lftp
          
      - name: Cleanup
        run: rm -f deploy_script.lftp

      - name: Deployment Success
        run: |
          echo "üéâ D√©ploiement termin√© avec succ√®s!"
          echo "üåê Site accessible sur: https://voyage.mathisinternicola.fr"
          echo "üìÅ Seuls les fichiers statiques ont √©t√© d√©ploy√©s" 
