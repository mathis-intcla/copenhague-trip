name: Build and Deploy to Infomaniak Node.js Hosting

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies (build)
        run: npm ci

      - name: Build Next.js static site
        run: npm run build
        
      - name: Prepare production files
        run: |
          echo "=== Pr√©paration des fichiers de production ==="
          
          # Copier les fichiers statiques de out/ vers la racine
          cp -r out/* ./
          
          # Cr√©er le package.json de production (d√©j√† fait)
          echo "‚úÖ package.json de production cr√©√©"
          
          # Serveur Express simple (d√©j√† fait) 
          echo "‚úÖ server.js pour Express cr√©√©"
          
          # V√©rifier les fichiers finaux
          echo "=== Fichiers qui seront d√©ploy√©s ==="
          ls -la
          
          echo "=== V√©rification des fichiers critiques ==="
          test -f index.html && echo "‚úÖ index.html pr√©sent" || echo "‚ùå index.html manquant"
          test -f server.js && echo "‚úÖ server.js pr√©sent" || echo "‚ùå server.js manquant"
          test -f package.json && echo "‚úÖ package.json pr√©sent" || echo "‚ùå package.json manquant"
          test -d _next && echo "‚úÖ dossier _next pr√©sent" || echo "‚ùå dossier _next manquant"

      - name: Deploy to Infomaniak
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          dangerous-clean-slate: true
          exclude: |
            **/node_modules/**
            **/src/**
            **/.git*/**
            **/.github*/**
            **/out/**
            **/*.md
            **/tailwind.config.ts
            **/tsconfig.json
            **/next.config.js
            **/postcss.config.mjs
            **/eslint.config.mjs
            **/.eslintrc.json

      - name: Deployment Success
        run: |
          echo "üéâ D√©ploiement termin√©!"
          echo "üåê Site: https://voyage.mathisinternicola.fr"
          echo "üì¶ Serveur Node.js + fichiers statiques d√©ploy√©s"
          echo "üöÄ Infomaniak va maintenant pouvoir faire 'npm start'" 
